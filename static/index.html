<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Claude Code Web Agent</title>
    <style>
      :root {
        --bg: #f4f7f5;
        --panel: #ffffff;
        --ink: #1f2933;
        --muted: #52606d;
        --brand: #0b6e4f;
        --brand-2: #14a06f;
        --line: #d9e2ec;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
        background: radial-gradient(circle at 0 0, #e7f5ee, var(--bg) 60%);
        color: var(--ink);
      }
      .wrap { max-width: 920px; margin: 28px auto; padding: 0 14px; }
      .card {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 14px;
        box-shadow: 0 12px 40px rgba(15, 23, 42, 0.08);
        overflow: hidden;
      }
      .head { padding: 16px 18px; border-bottom: 1px solid var(--line); }
      .head h1 { margin: 0; font-size: 19px; }
      .head p { margin: 6px 0 0; font-size: 13px; color: var(--muted); }
      #chat {
        min-height: 420px;
        max-height: 62vh;
        overflow-y: auto;
        padding: 18px;
        background: linear-gradient(180deg, #fcfffd 0%, #f8fbf9 100%);
      }
      .msg {
        margin-bottom: 12px;
        padding: 10px 12px;
        border-radius: 10px;
        white-space: pre-wrap;
      }
      .user { background: #e8f5ef; border: 1px solid #c7e8d9; }
      .bot { background: #fff; border: 1px solid var(--line); }
      .err { background: #fff1f0; border: 1px solid #ffccc7; }
      .toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 10px 14px;
        border-top: 1px solid var(--line);
        border-bottom: 1px solid var(--line);
        background: #fbfdfc;
      }
      .toolbar .meta { font-size: 12px; color: var(--muted); }
      form {
        display: flex;
        gap: 10px;
        padding: 14px;
        background: #fff;
      }
      input {
        flex: 1;
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 11px 12px;
        font-size: 15px;
      }
      button {
        border: 0;
        border-radius: 10px;
        padding: 0 16px;
        background: linear-gradient(120deg, var(--brand), var(--brand-2));
        color: #fff;
        font-weight: 700;
        cursor: pointer;
      }
      button.secondary {
        background: #e6f4ee;
        color: #0b6e4f;
        border: 1px solid #bfe4d3;
      }
      button:disabled { opacity: 0.65; cursor: not-allowed; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <div class="head">
          <h1>Claude Code 受限智能体</h1>
          <p>默认保持同一会话；仅当你点击“新对话”时才会创建新 session。</p>
        </div>
        <div class="toolbar">
          <div class="meta" id="session-meta">session: (未建立)</div>
          <button id="new-chat" class="secondary" type="button">新对话</button>
        </div>
        <div id="chat"></div>
        <form id="chat-form">
          <input id="message" autocomplete="off" placeholder="输入你的问题..." required />
          <button id="send" type="submit">发送</button>
        </form>
      </div>
    </div>

    <script>
      const chat = document.getElementById("chat");
      const form = document.getElementById("chat-form");
      const input = document.getElementById("message");
      const send = document.getElementById("send");
      const newChat = document.getElementById("new-chat");
      const sessionMeta = document.getElementById("session-meta");

      let conversationId = null;
      let nextMessageStartsNewConversation = false;

      const addMessage = (text, type) => {
        const div = document.createElement("div");
        div.className = `msg ${type}`;
        div.textContent = text;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
      };

      const refreshMeta = () => {
        sessionMeta.textContent = `session: ${conversationId || "(未建立)"}`;
      };

      newChat.addEventListener("click", () => {
        nextMessageStartsNewConversation = true;
        conversationId = null;
        chat.innerHTML = "";
        addMessage("Claude: 已切换为新对话模式，下一条消息将创建新的 session。", "bot");
        refreshMeta();
        input.focus();
      });

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const message = input.value.trim();
        if (!message) return;

        addMessage(`你: ${message}`, "user");
        input.value = "";
        input.focus();
        send.disabled = true;

        try {
          const response = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message,
              conversation_id: conversationId,
              new_conversation: nextMessageStartsNewConversation,
            }),
          });

          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.detail || "请求失败");
          }

          conversationId = data.conversation_id;
          nextMessageStartsNewConversation = false;
          refreshMeta();
          addMessage(`Claude: ${data.reply}\n[log] ${data.log_file}`, "bot");
        } catch (error) {
          addMessage(`错误: ${error.message}`, "err");
        } finally {
          send.disabled = false;
        }
      });

      addMessage("Claude: 已连接。默认复用会话，点击“新对话”才会重置记忆。", "bot");
      refreshMeta();
    </script>
  </body>
</html>
