name: Auto Deploy to Server

on:
  push:
    branches:
      - v1
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          debug: true
          timeout: 30s
          command_timeout: 15m
          script: |
            set -e
            set -x

            date
            echo "=== SSH OK ==="
            whoami
            hostname

            cd /root/claude-memory-system

            # 禁止 Git 交互提示
            export GIT_TERMINAL_PROMPT=0
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh
            ssh-keyscan -H github.com >> ~/.ssh/known_hosts 2>/dev/null || true

            echo "=== git remote ==="
            git remote -v

            echo "=== stopping services ==="
            # feishu_ws_bridge
            if pids=$(pgrep -f "feishu_ws_bridge.py"); then
              echo "Stopping feishu_ws_bridge: $pids"
              kill -TERM $pids 2>/dev/null || true
            else
              echo "No feishu_ws_bridge process"
            fi

            # uvicorn
            if pids=$(pgrep -f "uvicorn app:app"); then
              echo "Stopping uvicorn: $pids"
              kill -TERM $pids 2>/dev/null || true
            else
              echo "No uvicorn process"
            fi

            sleep 3

            # force kill if still running (never fail)
            pgrep -f "feishu_ws_bridge.py" | xargs -r kill -KILL 2>/dev/null || true
            pgrep -f "uvicorn app:app" | xargs -r kill -KILL 2>/dev/null || true

            echo "Services stopped (best-effort)"

            echo "=== updating code ==="
            git fetch origin
            git reset --hard origin/v1
            git rev-parse --short HEAD

            echo "=== checking uv ==="
            if ! command -v uv >/dev/null 2>&1; then
              curl -LsSf https://astral.sh/uv/install.sh | sh
              export PATH="$HOME/.cargo/bin:$PATH"
            fi
            uv --version

            echo "=== installing dependencies ==="
            export UV_HTTP_TIMEOUT=60
            uv sync --dev -v

            echo "=== verifying ==="
            uv run python -c "import sys; print(f'Python {sys.version}')"

            echo "=== done ==="
            echo "Services stopped. Restart manually if needed."
