name: Auto Deploy to Server

on:
  push:
    branches:
      - v1
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Debug CI ssh key fingerprint
        shell: bash
        run: |
          set -e
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_ci
          chmod 600 ~/.ssh/id_ci
          ssh-keygen -y -f ~/.ssh/id_ci > ~/.ssh/id_ci.pub
          echo "=== SSH Key Fingerprint ==="
          ssh-keygen -lf ~/.ssh/id_ci.pub
          echo "Expected: SHA256:OHcgAhLAtnCHK8mgIbgKQuiGCuZwLhvGKmAKDEikJWE"

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: |
            ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          debug: true
          timeout: 30s
          command_timeout: 15m
          script: |
            set -e
            set -x

            date
            echo "=== SSH OK ==="
            whoami
            hostname

            # 确保项目目录存在
            mkdir -p /root/claude-memory-system
            cd /root/claude-memory-system

            mkdir -p ~/.ssh
            chmod 700 ~/.ssh
            ssh-keyscan -H github.com >> ~/.ssh/known_hosts 2>/dev/null || true

            # 如果目录是空的,初始化 git
            if [ ! -d .git ]; then
              echo "=== initializing git repo ==="
              git clone git@github.com:hwj123hwj/claude-memory-system.git temp
              mv temp/.git .
              rm -rf temp
              git reset --hard HEAD
            fi

            # 禁止 Git 交互提示
            export GIT_TERMINAL_PROMPT=0

            echo "=== git remote ==="
            git remote -v

            echo "=== stopping old services (if running) ==="
            if [ -f logs/uvicorn.pid ]; then
              old_pid="$(cat logs/uvicorn.pid || true)"
              if [ -n "${old_pid}" ] && kill -0 "${old_pid}" 2>/dev/null; then
                kill "${old_pid}" || true
                sleep 1
              fi
              rm -f logs/uvicorn.pid
            fi
            if command -v pgrep >/dev/null 2>&1; then
              pgrep -f "uvicorn app:app --host 0.0.0.0 --port 8000" | xargs -r kill || true
            fi

            if [ -f logs/feishu_ws_bridge.pid ]; then
              old_pid="$(cat logs/feishu_ws_bridge.pid || true)"
              if [ -n "${old_pid}" ] && kill -0 "${old_pid}" 2>/dev/null; then
                kill "${old_pid}" || true
                sleep 1
              fi
              rm -f logs/feishu_ws_bridge.pid
            fi
            if command -v pgrep >/dev/null 2>&1; then
              pgrep -f "python feishu_ws_bridge.py" | xargs -r kill || true
            fi

            echo "=== updating code ==="
            git fetch origin
            git reset --hard origin/v1
            git rev-parse --short HEAD

            echo "=== checking uv ==="
            if ! command -v uv >/dev/null 2>&1; then
              curl -LsSf https://astral.sh/uv/install.sh | sh
              export PATH="$HOME/.cargo/bin:$PATH"
            fi
            uv --version

            echo "=== installing dependencies ==="
            export UV_HTTP_TIMEOUT=60
            uv sync --dev -v

            echo "=== verifying ==="
            uv run python -c "import sys; print(f'Python {sys.version}')"

            echo "=== starting services ==="

            # 创建日志目录
            mkdir -p logs

            # 启动 uvicorn
            echo "Starting uvicorn..."
            nohup uv run uvicorn app:app --host 0.0.0.0 --port 8000 > logs/uvicorn.log 2>&1 &
            echo $! > logs/uvicorn.pid
            sleep 2
            if ! kill -0 "$(cat logs/uvicorn.pid)" 2>/dev/null; then
              echo "uvicorn failed to start; tail logs/uvicorn.log"
              tail -n 100 logs/uvicorn.log || true
              exit 1
            fi

            # 启动飞书桥接
            echo "Starting feishu_ws_bridge..."
            nohup uv run python feishu_ws_bridge.py > logs/feishu_ws_bridge.log 2>&1 &
            echo $! > logs/feishu_ws_bridge.pid
            sleep 2
            if ! kill -0 "$(cat logs/feishu_ws_bridge.pid)" 2>/dev/null; then
              echo "feishu_ws_bridge failed to start; tail logs/feishu_ws_bridge.log"
              tail -n 100 logs/feishu_ws_bridge.log || true
              exit 1
            fi

            echo "=== done ==="
            echo "Deployment completed. Services started."
