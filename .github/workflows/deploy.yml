name: Auto Deploy to Server

on:
  push:
    branches:
      - v1
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          debug: true
          timeout: 30s
          command_timeout: 15m
          script: |
            set -e
            set -x

            date
            echo "=== SSH OK ==="
            whoami
            hostname

            # 确保项目目录存在
            mkdir -p /root/claude-memory-system
            cd /root/claude-memory-system

            # 如果目录是空的,初始化 git
            if [ ! -d .git ]; then
              echo "=== initializing git repo ==="
              git clone git@github.com:hwj123hwj/claude-memory-system.git temp
              mv temp/.git .
              rm -rf temp
              git reset --hard HEAD
            fi

            # 禁止 Git 交互提示
            export GIT_TERMINAL_PROMPT=0
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh
            ssh-keyscan -H github.com >> ~/.ssh/known_hosts 2>/dev/null || true

            echo "=== git remote ==="
            git remote -v

            echo "=== skipping service stop (manual restart required) ==="
            echo "Note: Services will NOT be stopped automatically"
            echo "Please restart manually after deployment if needed"

            echo "=== updating code ==="
            git fetch origin
            git reset --hard origin/v1
            git rev-parse --short HEAD

            echo "=== checking uv ==="
            if ! command -v uv >/dev/null 2>&1; then
              curl -LsSf https://astral.sh/uv/install.sh | sh
              export PATH="$HOME/.cargo/bin:$PATH"
            fi
            uv --version

            echo "=== installing dependencies ==="
            export UV_HTTP_TIMEOUT=60
            uv sync --dev -v

            echo "=== verifying ==="
            uv run python -c "import sys; print(f'Python {sys.version}')"

            echo "=== restarting services ==="

            # 1. 停止旧服务
            pkill -f "uvicorn app:app" || true
            pkill -f "feishu_ws_bridge.py" || true
            sleep 3

            # 强制清理(如果还在运行)
            pkill -KILL -f "uvicorn app:app" 2>/dev/null || true
            pkill -KILL -f "feishu_ws_bridge.py" 2>/dev/null || true
            sleep 1

            # 2. 检查端口
            if netstat -tlnp 2>/dev/null | grep -q ":8000 "; then
              echo "WARNING: Port 8000 still in use, forcing cleanup"
              lsof -ti:8000 | xargs kill -9 2>/dev/null || true
              sleep 1
            fi

            # 3. 创建日志目录
            mkdir -p logs

            # 4. 启动 uvicorn
            echo "Starting uvicorn..."
            nohup uv run uvicorn app:app --host 0.0.0.0 --port 8000 > logs/uvicorn.log 2>&1 &
            UVICORN_PID=$!
            echo $UVICORN_PID > logs/uvicorn.pid

            # 5. 等待启动
            sleep 5

            # 6. 验证进程
            if ! kill -0 $UVICORN_PID 2>/dev/null; then
              echo "ERROR: uvicorn process died"
              cat logs/uvicorn.log
              exit 1
            fi

            # 7. 验证端口
            if ! netstat -tlnp 2>/dev/null | grep -q ":8000 "; then
              echo "ERROR: Port 8000 not listening"
              cat logs/uvicorn.log
              exit 1
            fi

            # 8. 健康检查
            echo "Running health check..."
            sleep 2
            if command -v curl >/dev/null 2>&1; then
              HEALTH_CHECK=$(curl -s http://localhost:8000/healthz || echo "failed")
              if echo "$HEALTH_CHECK" | grep -q '"status"'; then
                echo "Health check passed: $HEALTH_CHECK"
              else
                echo "WARNING: Health check failed, but service may be starting"
              fi
            fi

            echo "=== services started successfully ==="
            echo "uvicorn PID: $UVICORN_PID"
            echo "Logs: logs/uvicorn.log"

            echo "=== done ==="
            echo "Deployment completed. Services are running."
