# Claude Code Web Agent 开发总结

## 1. 需求总结

本次需求目标：

1. 在 `store_test` 下补充 `md` 和 `yaml` 测试文档。
2. 基于 Claude Code SDK 实现一个“仅允许操作当前项目目录”的智能体。
3. 提供一个网页对话界面，用户通过网页发问，智能体调用 Claude Code 执行文件读取/编辑等操作。
4. 支持完整日志落盘，能追踪每轮请求、工具调用、权限决策与最终结果，便于排障。

核心约束：

1. 工作目录限制在 `D:\develop\test`。
2. 禁止越界路径访问。
3. 支持对 `store_test` 子目录（含多层目录）正常读写。

## 2. 最终实现

### 2.1 文件与模块

1. 后端服务：`app.py`（FastAPI + Claude Code SDK 对接）
2. 权限校验：`agent_security.py`（路径递归校验）
3. 日志模块：`chat_logging.py`（按会话写 `jsonl` 日志）
4. 前端页面：`static/index.html`（聊天界面）
5. 测试：`tests/test_agent_security.py`、`tests/test_chat_logging.py`
6. 依赖：`requirements.txt`
7. 测试文档：`store_test/*.md`、`store_test/*.yaml`

### 2.2 安全与权限

1. `cwd` 固定为当前项目根目录。
2. 对工具输入中的路径字段做递归扫描，发现越界路径直接拒绝。
3. `Bash` 在权限回调中拒绝（如果模型尝试调用会被拦截并记录）。
4. 响应中返回本次日志文件路径，便于快速定位问题。

### 2.3 日志能力

每次对话生成一个独立日志文件，路径示例：

`logs/chat-20260214-192659-d64440b2.jsonl`

日志包含：

1. `request`：用户问题、cwd、允许工具
2. `permission_check / permission_allow / permission_deny`
3. `message`：SDK 返回的所有消息（系统消息、工具调用、结果消息等）
4. `error`：运行异常
5. `response`：最终返回给网页的回复

## 3. 开发过程中的关键问题与解决

### 问题 1：SDK `can_use_tool` 与字符串 `prompt` 不兼容

现象：

- 使用字符串 prompt 调用时，抛错提示 `can_use_tool callback requires streaming mode`。

处理：

1. 改为异步流输入（stream prompt）。
2. 按当前 SDK 版本要求，消息结构改为 `type=user` 的 message 格式。

结果：

- `can_use_tool` 回调正常生效，可持续做权限拦截。

### 问题 2：日志序列化失败导致中断

现象：

- 日志写入时报错：`Object of type TextBlock is not JSON serializable`。

处理：

1. 增加深度 JSON 安全转换（对象、Path、model_dump、嵌套结构统一处理）。
2. 增加对应测试 `test_serialize_message_is_json_safe`。

结果：

- 日志稳定写入，不再因对象序列化中断对话。

### 问题 3：只出现“我来查看”但无后续总结

定位依据：

- 日志中出现 `ResultMessage.subtype = error_max_turns`，`num_turns = 7`。

结论：

- 不是因为子文件夹不可访问，而是会话轮次上限触发，模型在探测目录过程中耗尽轮次。

处理：

1. 将 `max_turns` 提升为 `30`（`app.py`）。

结果：

- 同类“先搜索再总结”场景可正常完成后续回复。

## 4. 验证结果

1. 单测通过：`pytest -q`（当前 8 项通过）。
2. 网页可访问：`http://127.0.0.1:8000` 返回 200。
3. `/api/chat` 正常返回 `reply + workspace + log_file`。
4. `store_test/memory` 多级子目录可被发现与读取。

## 5. 运行说明

```bash
pip install -r requirements.txt
uvicorn app:app --reload --port 8000
```

打开：

`http://127.0.0.1:8000`

